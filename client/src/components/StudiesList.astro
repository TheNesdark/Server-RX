---
import { getStudies } from '../services/Orthan';

// Interfaces para tipado de datos
interface DicomStudy {
  ID: string;
  PatientMainDicomTags?: {
    PatientName?: string;
  };
  MainDicomTags?: {
    StudyDate?: string;
    StudyDescription?: string;
    AccessionNumber?: string;
    StudyID?: string;
  };
}

interface FormattedStudy {
  id: string;
  patientName: string;
  studyDate: string;
  studyType: string;
}

// Obtener estudios desde el servidor usando el servicio
const studies = await getStudies();

// Formatear datos para mostrar en la tabla
const formattedStudies: FormattedStudy[] = studies.map((study: DicomStudy) => ({
  id: study.ID,
  patientName: study.PatientMainDicomTags?.PatientName?.replace("^", "") || "Desconocido",
  studyDate: study.MainDicomTags?.StudyDate 
    ? `${study.MainDicomTags.StudyDate.substring(0, 4)}-${study.MainDicomTags.StudyDate.substring(4, 6)}-${study.MainDicomTags.StudyDate.substring(6, 8)}`
    : "N/A",
  studyType: study.MainDicomTags?.StudyDescription ||
             study.MainDicomTags?.AccessionNumber ||
             study.MainDicomTags?.StudyID ||
             "Estudio DICOM",
}));
---

<section>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre del Paciente</th>
        <th>Fecha del Estudio</th>
        <th>Tipo de Estudio</th>
      </tr>
    </thead>
    <tbody>
      {formattedStudies.map((study: FormattedStudy) => (
        <tr
          onclick={`window.location.href='/viewer/${study.id}'`}
          style="cursor: pointer;"
        >
          <td>{study.id}</td>
          <td>{study.patientName}</td>
          <td>{study.studyDate}</td>
          <td>{study.studyType}</td>
        </tr>
      ))}
    </tbody>
  </table>
</section>

<style>
  section {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
  }
</style>