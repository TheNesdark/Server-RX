---
import Layout from "../layouts/layout.astro";
import StudiesList from "../components/StudiesList.astro";
import { obtenerEstudios, getTotalEstudios } from "@/services/Orthan";
import PaginationNav from "../components/PaginationNav.astro";

// Obtener el número de página y término de búsqueda de los parámetros de URL
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1');
const searchTerm = url.searchParams.get('q') || '';

// Asegurar que page sea un número válido
const currentPage = isNaN(page) || page < 1 ? 1 : page;

// Límite fijo de estudios por página
const limit = 10;
const offset = (currentPage - 1) * limit;

// Obtener estudios y total considerando el término de búsqueda
const [studies, total] = await Promise.all([
  obtenerEstudios(limit, offset, searchTerm),
  getTotalEstudios(searchTerm)
]);
const totalPages = Math.ceil(total / limit);
---

<Layout>
    <StudiesList
        studies={studies}
        total={total}
        limit={limit}
        currentPage={currentPage}
    />
    <PaginationNav
        total={total}
        currentPage={currentPage}
        totalPages={totalPages}
    />
</Layout>

<style>
    :global(body) {
        background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%);
    }
</style>
