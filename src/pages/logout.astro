---
// Eliminar cookie de sesión admin
Astro.cookies.delete('auth_token', { path: '/' });
// Eliminar también cualquier cookie de paciente (auth_patient_*)
const allCookies = Astro.cookies.headers();
for (const [name] of allCookies) {
  if (name.startsWith('auth_patient_')) {
    Astro.cookies.delete(name, { path: '/' });
  }
}
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cerrando sesión...</title>
</head>
<body>
  <script>
    // Limpiar caché del Service Worker antes de redirigir
    // Previene que imágenes médicas queden accesibles sin autenticación
    async function logoutAndRedirect() {
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const swController = navigator.serviceWorker.controller;
        // Esperar confirmación del SW en lugar de un timeout fijo arbitrario
        await new Promise((resolve) => {
          const timeout = setTimeout(resolve, 500); // fallback si SW no responde
          navigator.serviceWorker.addEventListener('message', function onMsg(e) {
            if (e.data?.type === 'CACHE_CLEARED') {
              clearTimeout(timeout);
              navigator.serviceWorker.removeEventListener('message', onMsg);
              resolve(undefined);
            }
          });
          swController.postMessage({ type: 'CLEAR_CACHE' });
        });
      }
      window.location.replace('/login');
    }
    logoutAndRedirect();
  </script>
</body>
</html>
