---
// src/pages/viewer-lite/[studyId].astro
import { actions } from "astro:actions";
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import { GetDNIbyStudyID } from "@/libs/orthanc"
import { getViewerLiteSeriesData } from "@/utils/viewerLite.server";

// 1. Obtener el studyId de los parámetros de la URL
const { studyId } = Astro.params;
if (!studyId) {
  return new Response("No se proporcionó un ID de estudio", { status: 400 });
}

// 2. Obtener la cedula del paciente de ese estudio
const DNI = await GetDNIbyStudyID(studyId);
if (!DNI) {
  return new Response("No existe ese estudio", { status: 404 });
}

// 3. Manejar la autenticación mediante cookie y formulario
const cookieName = `auth_lite_${studyId}`;
const verifyResult = Astro.getActionResult(actions.verifyLiteAccess);
const verifyData = verifyResult?.data as { success?: boolean; studyId?: string } | undefined;
const errorMsg = verifyResult?.error?.message || "";

const authCookie = Astro.cookies.get(cookieName);
const isCookieAuthorized =
  authCookie?.value?.trim().toUpperCase() === String(DNI).trim().toUpperCase();
const isActionAuthorized = verifyData?.success === true && verifyData.studyId === studyId;
const isAuthorized = isCookieAuthorized || isActionAuthorized;

// 4. Si está autorizado, obtener los datos de las series e instancias
const seriesData = isAuthorized ? await getViewerLiteSeriesData(studyId) : [];
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DICOM Viewer Lite</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" />
  </head>
  <body>
    {!isAuthorized ? (
      <div class="login-container">
        <div class="login-box">
          <h2>Acceso al Estudio</h2>
          <p>Por favor, ingrese la cédula del paciente para ver las imágenes.</p>
          <form method="POST" action={actions.verifyLiteAccess}>
            <input type="hidden" name="studyId" value={studyId} />
            <input 
              type="text" 
              name="cedula" 
              placeholder="Cédula / ID de Paciente" 
              required 
              autofocus
            />
            {errorMsg && <p class="error">{errorMsg}</p>}
            <button type="submit">Ver Estudio</button>
          </form>
        </div>
      </div>
    ) : (
      <div class="viewer-container">
        <ThumbnailSidebar client:load series={seriesData} />
        <div class="main-viewer" id="viewer-viewport">
          <div id="loader" style="display: none; color: white;">Cargando...</div>
          <img id="renderedImage" src="" alt="DICOM" style="display: none;" />
        </div>
      </div>
    )}

    {isAuthorized && (
      <>
        <div id="series-metadata" data-series={JSON.stringify(seriesData)}></div>
        <script>
          import { initViewerLite } from '@/utils/viewerLite.client';

          initViewerLite();
        </script>
      </>
    )}

    <style is:global>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Source Sans 3", "Space Grotesk", sans-serif;
        background:
          radial-gradient(900px circle at 12% -10%, rgba(34, 211, 238, 0.08), transparent 60%),
          linear-gradient(180deg, #0c1216 0%, #06080a 100%);
        color: #f8fafc;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: radial-gradient(circle at 30% 20%, rgba(14, 165, 164, 0.12), transparent 55%), #06080a;
      }
      .login-box {
        background: rgba(15, 23, 42, 0.8);
        padding: 2rem;
        border-radius: 14px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(10px);
      }
      .login-box h2 { margin-bottom: 1rem; }
      .login-box p { margin-bottom: 1.5rem; color: #cbd5e1; font-size: 0.9rem; }
      .login-box input {
        width: 100%;
        padding: 0.8rem;
        margin-bottom: 1rem;
        background: #0b0f13;
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: white;
        border-radius: 10px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .login-box input:focus {
        outline: none;
        border-color: #22d3ee;
        box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.2);
      }
      .login-box button {
        width: 100%;
        padding: 0.8rem;
        background: linear-gradient(135deg, #0ea5a4 0%, #0f766e 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 10px 20px rgba(14, 165, 164, 0.3);
      }
      .login-box button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 28px rgba(14, 165, 164, 0.4);
      }
      .error { color: #fda4af; font-size: 0.8rem; margin-bottom: 1rem; }
      
      .viewer-container { display: flex; flex: 1; overflow: hidden; }
      .main-viewer { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
      #renderedImage { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
  </body>
</html>
