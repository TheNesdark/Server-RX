---
// src/pages/viewer-lite/[studyId].astro
import { actions } from "astro:actions";
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import { GetDNIbyStudyID } from "@/libs/orthanc"
import { verifyToken } from "@/libs/auth";
import { getStudySeriesData } from "@/utils/server";

// 1. Obtener el studyId de los parámetros de la URL
const { studyId } = Astro.params;
if (!studyId) {
  return new Response("No se proporcionó un ID de estudio", { status: 400 });
}

// 2. Obtener la cedula del paciente de ese estudio
const DNI = await GetDNIbyStudyID(studyId);
if (!DNI) {
  return new Response("No existe ese estudio", { status: 404 });
}

// 3. Manejar la autenticación mediante cookie JWT y formulario
const cookieName = `auth_lite_${studyId}`;
const verifyResult = Astro.getActionResult(actions.verifyLiteAccess);
const verifyData = verifyResult?.data as { success?: boolean; studyId?: string } | undefined;
const errorMsg = verifyResult?.error?.message || "";

const authCookie = Astro.cookies.get(cookieName);
var isCookieAuthorized = false;

if (authCookie) {
  const payload = await verifyToken(authCookie.value);
  if (payload && payload.studyId === studyId && String(payload.dni).trim() === String(DNI).trim()) {
    isCookieAuthorized = true;
  }
}

const isActionAuthorized = verifyData?.success === true && verifyData.studyId === studyId;
const isAuthorized = isCookieAuthorized || isActionAuthorized;

// 4. Si está autorizado, obtener los datos de las series e instancias
const seriesData = isAuthorized ? await getStudySeriesData(studyId) : [];
const commentPdfHref = isAuthorized
  ? `/viewer-lite/${encodeURIComponent(studyId)}/comment.pdf`
  : "";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DICOM Viewer Lite</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" />
  </head>
  <body>
    {!isAuthorized ? (
      <div class="login-container">
        <div class="login-box">
          <h2>Acceso al Estudio</h2>
          <p>Por favor, ingrese la cédula del paciente para ver las imágenes.</p>
          <form method="POST" action={actions.verifyLiteAccess}>
            <input type="hidden" name="studyId" value={studyId} />
            <input 
              type="text" 
              name="cedula" 
              placeholder="Cédula / ID de Paciente" 
              required 
              autofocus
            />
            {errorMsg && <p class="error">{errorMsg}</p>}
            <button type="submit">Ver Estudio</button>
          </form>
        </div>
      </div>
    ) : (
      <div class="viewer-container">
        <ThumbnailSidebar client:load series={seriesData} />
        <div class="main-viewer" id="viewer-viewport">
          <div id="loader" style="display: none; color: white;">Cargando...</div>
          <img id="renderedImage" src="" alt="DICOM" style="display: none;" />

          {
            commentPdfHref && (
              <div class="lite-comment-actions">
                <a
                  class="lite-comment-pdf-link"
                  href={commentPdfHref}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Abrir comentario PDF
                </a>
              </div>
            )
          }
        </div>
      </div>
    )}

    {isAuthorized && (
      <>
        <div id="series-metadata" data-series={JSON.stringify(seriesData)}></div>
        <script>
          import { initViewerLite } from '@/utils/client';

          initViewerLite();
        </script>
      </>
    )}

    <style is:global>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Source Sans 3", "Space Grotesk", sans-serif;
        background: linear-gradient(180deg, #14191b 0%, #0c1012 100%);
        color: #e6eceb;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .login-box {
        background: rgba(13, 17, 19, 0.86);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        max-width: 420px;
        width: 90%;
        border: 1px solid rgba(255, 255, 255, 0.16);
        box-shadow: 0 16px 28px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
      }
      .login-box h2 { margin-bottom: 0.8rem; }
      .login-box p { margin-bottom: 1.1rem; color: #a6b4b2; font-size: 0.9rem; }
      .login-box input {
        width: 100%;
        height: 42px;
        padding: 0 0.8rem;
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: #eef2f1;
        border-radius: 9px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .login-box input:focus {
        outline: none;
        border-color: #4fa89f;
        box-shadow: 0 0 0 3px rgba(79, 168, 159, 0.26);
      }
      .login-box button {
        width: 100%;
        height: 42px;
        background: #0f766e;
        color: white;
        border: none;
        border-radius: 9px;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.2s;
      }
      .login-box button:hover {
        background: #0c5d57;
      }
      .error { color: #fca5a5; font-size: 0.8rem; margin-bottom: 0.9rem; }
      
      .viewer-container { display: flex; flex: 1; overflow: hidden; }
      .main-viewer { flex: 1; background: #07090a; display: flex; align-items: center; justify-content: center; position: relative; }
      #loader { color: #cbd5d3 !important; }
      #renderedImage { max-width: 100%; max-height: 100%; object-fit: contain; }

      .lite-comment-actions {
        position: absolute;
        top: 76px;
        right: 16px;
        z-index: 20;
      }

      .lite-comment-pdf-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 40px;
        padding: 0 14px;
        border-radius: 9px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(13, 17, 19, 0.84);
        backdrop-filter: blur(8px);
        color: #e7efee;
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        text-decoration: none;
        transition: background-color 0.2s, border-color 0.2s;
      }

      .lite-comment-pdf-link:hover {
        background: rgba(21, 28, 30, 0.92);
        border-color: rgba(255, 255, 255, 0.34);
      }

      @media (max-width: 768px) {
        .lite-comment-actions {
          top: 64px;
          right: 10px;
        }

        .lite-comment-pdf-link {
          min-height: 36px;
          padding: 0 12px;
          font-size: 0.75rem;
        }
      }
    </style>
  </body>
</html>
