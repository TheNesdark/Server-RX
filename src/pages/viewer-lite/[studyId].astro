---
// src/pages/viewer-lite/[studyId].astro
import { actions } from "astro:actions";
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import { GetDNIbyStudyID } from "@/libs/orthanc"
import { getStudyCommentEntry } from "@/libs/db/studyComments";
import { getViewerLiteSeriesData } from "@/utils/viewerLite.server";

// 1. Obtener el studyId de los parámetros de la URL
const { studyId } = Astro.params;
if (!studyId) {
  return new Response("No se proporcionó un ID de estudio", { status: 400 });
}

// 2. Obtener la cedula del paciente de ese estudio
const DNI = await GetDNIbyStudyID(studyId);
if (!DNI) {
  return new Response("No existe ese estudio", { status: 404 });
}

// 3. Manejar la autenticación mediante cookie y formulario
const cookieName = `auth_lite_${studyId}`;
const verifyResult = Astro.getActionResult(actions.verifyLiteAccess);
const verifyData = verifyResult?.data as { success?: boolean; studyId?: string } | undefined;
const errorMsg = verifyResult?.error?.message || "";

const authCookie = Astro.cookies.get(cookieName);
const isCookieAuthorized =
  authCookie?.value?.trim().toUpperCase() === String(DNI).trim().toUpperCase();
const isActionAuthorized = verifyData?.success === true && verifyData.studyId === studyId;
const isAuthorized = isCookieAuthorized || isActionAuthorized;

// 4. Si está autorizado, obtener los datos de las series e instancias
const seriesData = isAuthorized ? await getViewerLiteSeriesData(studyId) : [];
const studyCommentEntry = isAuthorized
  ? getStudyCommentEntry(studyId)
  : { comment: "", updatedAt: null };
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DICOM Viewer Lite</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" />
  </head>
  <body>
    {!isAuthorized ? (
      <div class="login-container">
        <div class="login-box">
          <h2>Acceso al Estudio</h2>
          <p>Por favor, ingrese la cédula del paciente para ver las imágenes.</p>
          <form method="POST" action={actions.verifyLiteAccess}>
            <input type="hidden" name="studyId" value={studyId} />
            <input 
              type="text" 
              name="cedula" 
              placeholder="Cédula / ID de Paciente" 
              required 
              autofocus
            />
            {errorMsg && <p class="error">{errorMsg}</p>}
            <button type="submit">Ver Estudio</button>
          </form>
        </div>
      </div>
    ) : (
      <div class="viewer-container">
        <ThumbnailSidebar client:load series={seriesData} />
        <div class="main-viewer" id="viewer-viewport">
          <div id="loader" style="display: none; color: white;">Cargando...</div>
          <img id="renderedImage" src="" alt="DICOM" style="display: none;" />

          <details class="lite-comment-dock">
            <summary class="lite-comment-toggle">
              <span class="lite-comment-icon">❮</span>
            </summary>

            <aside class="lite-comment-panel">
              <p class="lite-comment-title">Comentario del estudio</p>

              <div class="lite-comment-body">
                <textarea
                  class="lite-comment-text"
                  readonly
                >{studyCommentEntry.comment || "Sin comentarios guardados."}</textarea>
                <p class="lite-comment-meta">
                  {
                    studyCommentEntry.updatedAt
                      ? `Actualizado: ${studyCommentEntry.updatedAt}`
                      : "Sin fecha de actualización"
                  }
                </p>
              </div>
            </aside>
          </details>
        </div>
      </div>
    )}

    {isAuthorized && (
      <>
        <div id="series-metadata" data-series={JSON.stringify(seriesData)}></div>
        <script>
          import { initViewerLite } from '@/utils/viewerLite.client';

          initViewerLite();
        </script>
      </>
    )}

    <style is:global>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Source Sans 3", "Space Grotesk", sans-serif;
        background: linear-gradient(180deg, #14191b 0%, #0c1012 100%);
        color: #e6eceb;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .login-box {
        background: rgba(13, 17, 19, 0.86);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        max-width: 420px;
        width: 90%;
        border: 1px solid rgba(255, 255, 255, 0.16);
        box-shadow: 0 16px 28px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
      }
      .login-box h2 { margin-bottom: 0.8rem; }
      .login-box p { margin-bottom: 1.1rem; color: #a6b4b2; font-size: 0.9rem; }
      .login-box input {
        width: 100%;
        height: 42px;
        padding: 0 0.8rem;
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: #eef2f1;
        border-radius: 9px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .login-box input:focus {
        outline: none;
        border-color: #4fa89f;
        box-shadow: 0 0 0 3px rgba(79, 168, 159, 0.26);
      }
      .login-box button {
        width: 100%;
        height: 42px;
        background: #0f766e;
        color: white;
        border: none;
        border-radius: 9px;
        cursor: pointer;
        font-weight: 700;
        transition: background-color 0.2s;
      }
      .login-box button:hover {
        background: #0c5d57;
      }
      .error { color: #fca5a5; font-size: 0.8rem; margin-bottom: 0.9rem; }
      
      .viewer-container { display: flex; flex: 1; overflow: hidden; }
      .main-viewer { flex: 1; background: #07090a; display: flex; align-items: center; justify-content: center; position: relative; }
      #loader { color: #cbd5d3 !important; }
      #renderedImage { max-width: 100%; max-height: 100%; object-fit: contain; }

      .lite-comment-dock {
        position: absolute;
        top: 76px;
        right: 0;
        z-index: 20;
        display: flex;
        align-items: flex-start;
        --lite-comment-panel-width: min(320px, calc(100vw - 24px));
      }

      .lite-comment-toggle {
        list-style: none;
        cursor: pointer;
        width: 34px;
        height: 48px;
        border-radius: 10px 0 0 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-right: none;
        background: rgba(13, 17, 19, 0.84);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lite-comment-toggle::-webkit-details-marker {
        display: none;
      }

      .lite-comment-icon {
        color: #b7c6c4;
        font-size: 0.95rem;
        line-height: 1;
        transition: transform 0.24s ease;
      }

      .lite-comment-dock[open] .lite-comment-icon {
        transform: rotate(180deg);
      }

      .lite-comment-panel {
        width: var(--lite-comment-panel-width);
        max-width: var(--lite-comment-panel-width);
        border-radius: 10px 0 0 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-right: none;
        background: rgba(13, 17, 19, 0.84);
        backdrop-filter: blur(8px);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        overflow: hidden;
        opacity: 1;
        transform: translateX(0);
        transform-origin: right center;
        transition:
          max-width 0.24s ease,
          opacity 0.24s ease,
          transform 0.24s ease,
          padding 0.24s ease,
          border-color 0.24s ease;
      }

      .lite-comment-title {
        margin: 0;
        color: #a6b4b2;
        font-size: 0.72rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .lite-comment-dock:not([open]) .lite-comment-panel {
        display: flex;
        max-width: 0;
        padding: 0;
        border-color: transparent;
        opacity: 0;
        transform: translateX(0);
        pointer-events: none;
      }

      .lite-comment-text {
        width: 100%;
        min-height: 94px;
        resize: vertical;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.04);
        color: #e6eceb;
        padding: 10px;
        font-size: 0.83rem;
        line-height: 1.35;
      }

      .lite-comment-text:focus {
        outline: none;
      }

      .lite-comment-meta {
        margin: 6px 0 0;
        font-size: 0.72rem;
        color: #9fb1af;
      }

      @media (max-width: 768px) {
        .lite-comment-dock {
          top: 64px;
          --lite-comment-panel-width: min(270px, calc(100vw - 44px));
        }

        .lite-comment-toggle {
          width: 32px;
          height: 44px;
        }

        .lite-comment-panel {
          padding: 8px;
        }

        .lite-comment-text {
          min-height: 78px;
          font-size: 0.78rem;
        }
      }
    </style>
  </body>
</html>
