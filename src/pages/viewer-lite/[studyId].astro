---
// src/pages/viewer-lite/[studyId].astro
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import { getSeriesByStudyId, getInstancesBySeriesId, GetDNIbyStudyID } from "@/libs/orthanc"
import { PROD } from "@/config";
import type { ThumbnailInfo } from "@/types";

// 1. Obtener el studyId de los parámetros de la URL
const { studyId } = Astro.params;
if (!studyId) {
  return new Response("No se proporcionó un ID de estudio", { status: 400 });
}

// 2. Obtener la cedula del paciente de ese estudio
const DNI = await GetDNIbyStudyID(studyId);
if (!DNI) {
  return new Response("No existe ese estudio", { status: 404 });
}

// 3. Manejar la autenticación mediante cookie y formulario
const cookieName = `auth_lite_${studyId}`;
let isAuthorized = false;
let errorMsg = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const cedula = formData.get("cedula");
  
  const normalizedCedula = String(cedula).trim().toUpperCase();
  const normalizedDNI = String(DNI).trim().toUpperCase();

  if (normalizedCedula === normalizedDNI) {
    Astro.cookies.set(cookieName, DNI, { 
      path: "/", 
      maxAge: 60 * 60 * 4,
      httpOnly: true,
      sameSite: "strict",
      secure: PROD
    });

    isAuthorized = true;
  } else {
    errorMsg = "La cédula ingresada no coincide con el estudio.";
  }
} else {
  const authCookie = Astro.cookies.get(cookieName);
  if (authCookie?.value === DNI ) {
    isAuthorized = true;
  }
}

// 4. Si está autorizado, obtener los datos de las series e instancias

const createErrorSeries = (id: string): ThumbnailInfo => ({
  id,
  instances: [],
  previewUrl: "/no-image.svg",
  modality: "Error",
  bodyPart: "Error",
});

const fetchSeriesData = async (seriesId: string): Promise<ThumbnailInfo> => {
  try {
    const { Instances = [], mainDicomTags } = await getInstancesBySeriesId(seriesId);
    const hasInstances = Instances.length > 0;

    return {
      id: seriesId,
      instances: Instances,
      previewUrl: hasInstances
        ? `/api/orthanc/instances/${Instances[0]}/preview`
        : "/no-image.svg",
      modality: mainDicomTags?.Modality ?? "N/A",
      bodyPart: mainDicomTags?.BodyPartExamined ?? "N/A",
    };
  } catch (error) {
    console.error(`[Viewer-Lite] Error cargando serie ${seriesId}:`, error);
    return createErrorSeries(seriesId);
  }
};

let seriesData: ThumbnailInfo[] = [];

if (isAuthorized) {
  const seriesIds = await getSeriesByStudyId(studyId);
  const allSeries = await Promise.all(seriesIds.map(fetchSeriesData));
  seriesData = allSeries.filter((series) => series.instances.length > 0);
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DICOM Viewer Lite</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" />
  </head>
  <body>
    {!isAuthorized ? (
      <div class="login-container">
        <div class="login-box">
          <h2>Acceso al Estudio</h2>
          <p>Por favor, ingrese la cédula del paciente para ver las imágenes.</p>
          <form method="POST">
            <input 
              type="text" 
              name="cedula" 
              placeholder="Cédula / ID de Paciente" 
              required 
              autofocus
            />
            {errorMsg && <p class="error">{errorMsg}</p>}
            <button type="submit">Ver Estudio</button>
          </form>
        </div>
      </div>
    ) : (
      <div class="viewer-container">
        <ThumbnailSidebar client:load series={seriesData} />
        <div class="main-viewer" id="viewer-viewport">
          <div id="loader" style="display: none; color: white;">Cargando...</div>
          <img id="renderedImage" src="" alt="DICOM" style="display: none;" />
        </div>
      </div>
    )}

    {isAuthorized && (
      <>
        <div id="series-metadata" data-series={JSON.stringify(seriesData)}></div>
        <script>
          import { activeSeriesId } from '@/stores/dicomStore';

          const renderedImage = document.getElementById('renderedImage') as HTMLImageElement;
          const loader = document.getElementById('loader');
          const seriesMetadataEl = document.getElementById('series-metadata');
          const seriesData = seriesMetadataEl ? JSON.parse(seriesMetadataEl.dataset.series || '[]') : [];

          async function updateRenderedImage(instanceId: string) {
            if (!instanceId || !renderedImage) return;
            renderedImage.style.display = "none";
            if (loader) loader.style.display = "block";
            const nuevaURL = `/api/orthanc/instances/${instanceId}/rendered?quality=90`;
            const imgPreloader = new Image();
            imgPreloader.onload = () => {
                renderedImage.src = nuevaURL;
                if (loader) loader.style.display = "none";
                renderedImage.style.display = "block";
            };
            imgPreloader.onerror = () => {
                 console.error("Error cargando imagen");
                 if (loader) loader.style.display = "none";
            }
            imgPreloader.src = nuevaURL;
          }

          activeSeriesId.subscribe((id: string) => {
            if (id) {
              const series = seriesData.find((s: any) => s.id === id);
              if (series && series.instances && series.instances.length > 0) {
                updateRenderedImage(series.instances[0]);
              }
            }
          });

          if (seriesData.length > 0 && !activeSeriesId.get()) {
            activeSeriesId.set(seriesData[0].id);
          }
        </script>
      </>
    )}

    <style is:global>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: "Source Sans 3", "Space Grotesk", sans-serif;
        background:
          radial-gradient(900px circle at 12% -10%, rgba(34, 211, 238, 0.08), transparent 60%),
          linear-gradient(180deg, #0c1216 0%, #06080a 100%);
        color: #f8fafc;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: radial-gradient(circle at 30% 20%, rgba(14, 165, 164, 0.12), transparent 55%), #06080a;
      }
      .login-box {
        background: rgba(15, 23, 42, 0.8);
        padding: 2rem;
        border-radius: 14px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(10px);
      }
      .login-box h2 { margin-bottom: 1rem; }
      .login-box p { margin-bottom: 1.5rem; color: #cbd5e1; font-size: 0.9rem; }
      .login-box input {
        width: 100%;
        padding: 0.8rem;
        margin-bottom: 1rem;
        background: #0b0f13;
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: white;
        border-radius: 10px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .login-box input:focus {
        outline: none;
        border-color: #22d3ee;
        box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.2);
      }
      .login-box button {
        width: 100%;
        padding: 0.8rem;
        background: linear-gradient(135deg, #0ea5a4 0%, #0f766e 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 10px 20px rgba(14, 165, 164, 0.3);
      }
      .login-box button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 28px rgba(14, 165, 164, 0.4);
      }
      .error { color: #fda4af; font-size: 0.8rem; margin-bottom: 1rem; }
      
      .viewer-container { display: flex; flex: 1; overflow: hidden; }
      .main-viewer { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
      #renderedImage { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
  </body>
</html>
