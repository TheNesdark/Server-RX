---
// src/pages/viewer-lite/[studyId].astro
import ViewerLayout from "@/layouts/ViewerLayout.astro";
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import PatientInfo from "@/components/modals/PatientInfo.astro";
import IdentityVerification from "@/components/modals/IdentityVerification.astro";
import { getStudySeriesData, validateStudyAccess } from "@/utils/server";
import { getLocalStudyById } from "@/libs/db";
import { actions } from "astro:actions";
import "@/styles/ViewerLite.global.css";
const { studyId } = Astro.params;

if (!studyId) {
  return Astro.redirect("/");
}

// 1. Validar Acceso (Admin o Paciente)
const { isAuthorized, isAdmin } = await validateStudyAccess(Astro, studyId);
let errorMsg: string | undefined = "";

// 2. Obtener el resultado de la acción de verificación (si se envió el formulario)
const verifyResult = Astro.getActionResult(actions.verifyLiteAccess);
const verifyData = verifyResult?.data;
errorMsg = verifyResult?.error?.message;
const isActionAuthorized = verifyData?.success === true && verifyData.studyId === studyId;

// 3. Si está autorizado por acción, actualizar estado
const finalIsAuthorized = isAuthorized || isActionAuthorized;

// 4. Si está autorizado, obtener los datos de las series e instancias
const seriesData = finalIsAuthorized ? await getStudySeriesData(studyId) : [];
const commentPdfHref = finalIsAuthorized
  ? `/reports/${encodeURIComponent(studyId)}`
  : "";
const studyData = getLocalStudyById(studyId);

---

<ViewerLayout title={`DICOM Viewer Lite`}>
  {!finalIsAuthorized ? (
    <IdentityVerification 
      studyId={studyId} 
      actions={actions} 
      errorMsg={errorMsg} 
    />
  ) : (
    <div class="viewer-layout">
      <header class="viewer-header">
        <div class="header-left">
          <a href="/" class="logo-link">
            <img src="/assets/logo.png" alt="Logo" width="32" height="32" />
            <div class="brand-info">
              <h1>Hospital Local de Montelibano</h1>
              <span>Visor de Imágenes Lite</span>
            </div>
          </a>
        </div>
        <div class="header-right">
          {commentPdfHref && (
            <a href={commentPdfHref} target="_blank" class="action-btn pdf-btn" title="Descargar Informe PDF">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <span>Informe PDF</span>
            </a>
          )}
        </div>
      </header>

      <div class="viewer-body">
        <ThumbnailSidebar client:load series={seriesData} />
        
        <main class="viewport-container" id="viewer-viewport">
          <div id="loader" class="viewer-loader">
            <div class="spinner"></div>
            <span>Cargando imagen...</span>
          </div>
          
          <img id="renderedImage" src="" alt="DICOM" class="main-image" />

          <PatientInfo studyData={studyData} />
        </main>
      </div>
    </div>
      <div id="series-metadata" data-series={JSON.stringify(seriesData)}></div>
      <script>
        import { initViewerLite } from '@/utils/client';
        initViewerLite();
      </script>
  )}
</ViewerLayout>

