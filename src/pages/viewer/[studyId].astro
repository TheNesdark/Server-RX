---
import ViewerLayout from "@/layouts/ViewerLayout.astro";
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import DicomViewer from "@/components/viewer/DicomViewer";
import ViewerToolbar from "@/components/viewer/ViewerToolbar.astro";
import HelpModal from "@/components/modals/HelpModal.astro";
import ShareModal from "@/components/modals/ShareModal.astro";
import PatientInfo from "@/components/modals/PatientInfo.astro";
import StudyComments from "@/components/modals/StudyComments.astro";
import IdentityVerification from "@/components/modals/IdentityVerification.astro";
import { actions } from "astro:actions";
import { getStudySeriesData, validateStudyAccess } from "@/utils/server";
import DeviceSuggestLite from "@/components/viewer/DeviceSuggestLite.astro";
import styles from "@/styles/ViewerPage.module.css";

const { studyId } = Astro.params;

if (!studyId) {
  return Astro.redirect("/");
}

// 1. Validar Acceso (Admin o Paciente)
const { isAuthorized, isAdmin } = await validateStudyAccess(Astro, studyId);
let errorMsg: string | undefined = "";

// 2. Obtener el resultado de la acción de verificación (si se envió el formulario)
const verifyResult = Astro.getActionResult(actions.verifyLiteAccess);
const verifyData = verifyResult?.data;
errorMsg = verifyResult?.error?.message;
const isActionAuthorized = verifyData?.success === true && verifyData.studyId === studyId;

// 3. Si está autorizado por acción, actualizar estado
const finalIsAuthorized = isAuthorized || isActionAuthorized;


// 4. Si está autorizado, obtener los datos de las series e instancias (con tamaño reducido para previsualización)
const seriesData = finalIsAuthorized ? await getStudySeriesData(studyId, 256) : [];
---

<ViewerLayout title="DICOM Viewer - Visor Médico">
  {!finalIsAuthorized ? (
    <IdentityVerification 
      studyId={studyId}
      actions={actions}
      errorMsg={errorMsg}
    />
  ) : (
    <>
      <ViewerToolbar studyId={studyId} />

      <div class={styles.viewerContainer}>
        <ThumbnailSidebar client:load series={seriesData} />
        <div class={styles.mainViewer}>
          <DicomViewer client:only="preact" />
          <PatientInfo studyId={studyId} />
          {isAdmin && <StudyComments studyId={studyId} />}
        </div>
      </div>

      <HelpModal />
      <ShareModal />
      <DeviceSuggestLite studyId={studyId} />
    </>
  )}
</ViewerLayout>
