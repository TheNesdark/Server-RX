---
import ThumbnailSidebar from "@/components/viewer/ThumbnailSidebar";
import DicomViewer from "@/components/viewer/DicomViewer";
import ViewerToolbar from "@/components/viewer/ViewerToolbar.astro";
import HelpModal from "@/components/modals/HelpModal.astro";
import ShareModal from "@/components/modals/ShareModal.astro";
import PatientInfo from "@/components/modals/PatientInfo.astro";
import StudyComments from "@/components/modals/StudyComments.astro";
import { orthancFetch } from "@/libs/orthanc";
import { getStudyCommentEntry } from "@/libs/db/studyComments";
import type { ThumbnailInfo, DicomStudy } from "@/types";
import { 
  formatDicomDate, 
  isValidStudyId, 
  normalizeDicomText, 
  formatPatientSex,
  calculateAge,
  formatDicomTime
} from "@/utils/client";
import { getStudySeriesData } from "@/utils/server";
import styles from "@/styles/ViewerPage.module.css";
import "@/styles/ViewerPage.global.css";

const { studyId } = Astro.params;
if (!isValidStudyId(studyId)) {
  return Astro.redirect("/");
}

const studyRes = await orthancFetch(`/studies/${studyId}`);
const studyData = await studyRes.json() as DicomStudy;

const patientName = normalizeDicomText(studyData?.PatientMainDicomTags?.PatientName) || "No disponible";
const patientId = normalizeDicomText(studyData?.PatientMainDicomTags?.PatientID) || "No disponible";
const patientSex = formatPatientSex(studyData?.PatientMainDicomTags?.PatientSex);
const patientAge = calculateAge(studyData?.PatientMainDicomTags?.PatientBirthDate);

const studyDate = formatDicomDate(studyData?.MainDicomTags?.StudyDate);
const studyTime = formatDicomTime(studyData?.MainDicomTags?.StudyTime);
const studyDescription = 
  normalizeDicomText(studyData?.MainDicomTags?.StudyDescription) || 
  normalizeDicomText(studyData?.MainDicomTags?.StudyID) || 
  "No disponible";

const institutionName = normalizeDicomText(studyData?.MainDicomTags?.InstitutionName) || "No disponible";
const referringPhysician = normalizeDicomText(studyData?.MainDicomTags?.ReferringPhysicianName);
const accessionNumber = normalizeDicomText(studyData?.MainDicomTags?.AccessionNumber);

// Pre-obtener la información para el Sidebar
const seriesData = await getStudySeriesData(studyId, 256);

const studyCommentEntry = getStudyCommentEntry(studyId);
const initialComment = studyCommentEntry.comment;
const initialUpdatedAt = studyCommentEntry.updatedAt;

---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DICOM Viewer - Visor Médico</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap"
    />
  </head>
  <body>
    <!-- Toolbar Superior -->
    <ViewerToolbar />

    <!-- Contenedor Principal -->
    <div class={styles.viewerContainer}>
      <ThumbnailSidebar client:load series={seriesData} />
      <div class={styles.mainViewer}>
        <DicomViewer client:only="preact" />

        <PatientInfo 
          patientName={patientName}
          patientId={patientId}
          patientSex={patientSex}
          patientAge={patientAge}
          studyDate={studyDate}
          studyTime={studyTime}
          studyDescription={studyDescription}
          institutionName={institutionName}
          referringPhysician={referringPhysician}
          accessionNumber={accessionNumber}
        />

        <StudyComments 
          studyId={studyId}
          initialComment={initialComment}
          initialUpdatedAt={initialUpdatedAt}
        />
      </div>
    </div>

    <!-- Modal de Ayuda -->
    <HelpModal />
    <ShareModal />

    <script>
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker.register('/sw.js')
						.then(reg => console.log('Service Worker registrado con éxito:', reg.scope))
						.catch(err => console.error('Error al registrar el Service Worker:', err));
				});
			}
		</script>
  </body>
</html>
